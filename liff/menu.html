// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
let allMenus = [];
let currentCategory = 'all';

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼å®šç¾©
const menuCategories = {
    1: 'cut',      // ã‚«ãƒƒãƒˆ
    2: 'color',    // ã‚«ãƒ©ãƒ¼
    3: 'perm',     // ãƒ‘ãƒ¼ãƒ
    4: 'treatment', // ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ
    5: 'treatment', // ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘
    6: 'color',    // ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼
    7: 'perm',     // ã‚«ãƒƒãƒˆ+ãƒ‘ãƒ¼ãƒ
    8: 'all'       // ãƒ•ãƒ«ã‚³ãƒ¼ã‚¹
};

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
const menuIcons = {
    1: 'âœ‚ï¸',  // ã‚«ãƒƒãƒˆ
    2: 'ğŸ¨',  // ã‚«ãƒ©ãƒ¼
    3: 'ğŸŒŠ',  // ãƒ‘ãƒ¼ãƒ
    4: 'ğŸ’†â€â™€ï¸', // ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ
    5: 'ğŸ§–â€â™€ï¸', // ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘
    6: 'âœ¨',  // ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼
    7: 'ğŸ’«',  // ã‚«ãƒƒãƒˆ+ãƒ‘ãƒ¼ãƒ
    8: 'ğŸ‘‘'   // ãƒ•ãƒ«ã‚³ãƒ¼ã‚¹
};

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª¬æ˜æ–‡
const menuDescriptions = {
    1: 'ãŠå®¢æ§˜ã®éª¨æ ¼ã‚„é«ªè³ªã«åˆã‚ã›ãŸã€ã‚ãªãŸã ã‘ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚',
    2: 'æœ€æ–°ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã‹ã‚‰ã€ãŠå®¢æ§˜ã«ä¼¼åˆã†ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼ã¾ã§å¹…åºƒãå¯¾å¿œã€‚',
    3: 'ãƒŠãƒãƒ¥ãƒ©ãƒ«ãªã‚¦ã‚§ãƒ¼ãƒ–ã‹ã‚‰ã€ã—ã£ã‹ã‚Šã‚«ãƒ¼ãƒ«ã¾ã§ã€ç†æƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Ÿç¾ã€‚',
    4: 'é«ªã®å†…å´ã‹ã‚‰æ½¤ã„ã‚’ä¸ãˆã€è‰¶ã‚„ã‹ãªç¾é«ªã¸ã¨å°ãã¾ã™ã€‚',
    5: 'é ­çš®ã®è¡€è¡Œã‚’ä¿ƒé€²ã—ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹åŠ¹æœã‚‚æŠœç¾¤ã€‚è‡³ç¦ã®ã²ã¨ã¨ãã‚’ã€‚',
    6: 'ã‚«ãƒƒãƒˆã¨ã‚«ãƒ©ãƒ¼ã‚’ã‚»ãƒƒãƒˆã§ã€‚ãƒˆãƒ¼ã‚¿ãƒ«ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆã§ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒã‚§ãƒ³ã‚¸ã€‚',
    7: 'ã‚«ãƒƒãƒˆã¨ãƒ‘ãƒ¼ãƒã®çµ„ã¿åˆã‚ã›ã§ã€å‹•ãã®ã‚ã‚‹ç«‹ä½“çš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã«ã€‚',
    8: 'ã‚«ãƒƒãƒˆã€ã‚«ãƒ©ãƒ¼ã€ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®å…¨ã¦ã‚’å«ã‚€ã€è´…æ²¢ãªãƒ•ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€‚'
};

// LIFFåˆæœŸåŒ–ã‚’å¾…ã¤
function waitForLiff() {
    return new Promise((resolve) => {
        const checkLiff = setInterval(() => {
            if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
                clearInterval(checkLiff);
                resolve();
            }
        }, 100);
        
        // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        setTimeout(() => {
            clearInterval(checkLiff);
            resolve();
        }, 10000);
    });
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // LIFFåˆæœŸåŒ–ã‚’å¾…ã¤
        await waitForLiff();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        await loadMenus();
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
    } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + error.message);
    }
});

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
async function loadMenus() {
    try {
        const response = await fetch('/api/menus', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        allMenus = await response.json();
        displayMenus();
        
    } catch (error) {
        console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
function displayMenus() {
    const menuList = document.getElementById('menu-list');
    menuList.innerHTML = '';
    
    allMenus.forEach((menu, index) => {
        const menuCard = createMenuCard(menu, index);
        menuList.appendChild(menuCard);
    });
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
function createMenuCard(menu, index) {
    const card = document.createElement('div');
    card.className = 'menu-card';
    card.dataset.category = menuCategories[menu.menu_id] || 'all';
    
    // äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã©ã†ã‹ï¼ˆä¾‹ï¼šã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼ã€ãƒ•ãƒ«ã‚³ãƒ¼ã‚¹ï¼‰
    const isPopular = [6, 8].includes(menu.menu_id);
    
    card.innerHTML = `
        <div class="menu-image">
            ${menuIcons[menu.menu_id] || 'ğŸ’‡â€â™€ï¸'}
            ${isPopular ? '<span class="menu-badge">äººæ°—</span>' : ''}
        </div>
        <div class="menu-info">
            ${isPopular ? '<span class="popular-badge">ğŸŒŸ äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>' : ''}
            <div class="menu-header">
                <h3 class="menu-name">${menu.name}</h3>
                <span class="menu-price">Â¥${menu.price.toLocaleString()}</span>
            </div>
            <p class="menu-description">
                ${menuDescriptions[menu.menu_id] || 'ãƒ—ãƒ­ã®ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆãŒä¸å¯§ã«æ–½è¡“ã„ãŸã—ã¾ã™ã€‚'}
            </p>
            <div class="menu-details">
                <div class="detail-item">
                    <span class="detail-icon">â±</span>
                    <span>${menu.duration}åˆ†</span>
                </div>
                <div class="detail-item">
                    <span class="detail-icon">ğŸ“</span>
                    <span>å…¨ã‚¹ã‚¿ãƒƒãƒ•å¯¾å¿œå¯</span>
                </div>
            </div>
        </div>
    `;
    
    // ã‚¯ãƒªãƒƒã‚¯ã§äºˆç´„ç”»é¢ã¸
    card.onclick = () => {
        if (confirm(`ã€Œ${menu.name}ã€ã‚’äºˆç´„ã—ã¾ã™ã‹ï¼Ÿ`)) {
            // é¸æŠã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            sessionStorage.setItem('selectedMenu', JSON.stringify(menu));
            window.location.href = './reservation.html';
        }
    };
    
    return card;
}

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
function filterByCategory(category) {
    currentCategory = category;
    
    // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.menu-card').forEach(card => {
        if (category === 'all' || card.dataset.category === category || card.dataset.category === 'all') {
            card.style.display = 'block';
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 10);
        } else {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.display = 'none';
            }, 300);
        }
    });
}

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .menu-card {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
    `;
    document.head.appendChild(style);
});